{"version":3,"sources":["../../../../../src/commands/eas-build/build/builders/iOSBuilder.ts"],"names":["iOSBuilder","constructor","ctx","prepareJobAsync","archiveUrl","buildProfile","workflow","Workflow","Generic","prepareGenericJobAsync","Managed","prepareManagedJobAsync","Error","ensureCredentialsAsync","shouldLoadCredentials","bundleIdentifier","commandCtx","projectDir","exp","provider","iOSCredentialsProvider","projectName","accountName","nonInteractive","skipCredentialsCheck","initAsync","credentialsSource","credentials","getCredentialsAsync","setupAsync","scheme","resolveScheme","ensureProjectConfiguredAsync","configureProjectAsync","spinner","profileName","ProvisioningProfileUtils","readProfileName","provisioningProfile","appleTeam","readAppleTeam","IOSConfig","BundleIdenitifer","setBundleIdentifierForPbxproj","ProvisioningProfile","setProvisioningProfileForPbxproj","appleTeamId","teamId","gitUtils","ensureGitStatusIsCleanAsync","succeed","err","DirtyGitTreeError","log","newLine","reviewAndCommitChangesAsync","chalk","green","figures","tick","e","fail","prepareJobCommonAsync","secrets","provisioningProfileBase64","distributionCertificate","dataBase64","certP12","password","certPassword","platform","Platform","iOS","projectUrl","type","BuildType","artifactPath","_buildProfile","packageJson","example","manifest","buildType","schemes","Scheme","getSchemesFromXcodeproj","length","sortedSchemes","bold","join","withoutTvOS","filter","i","includes","selectedScheme","name","message","choices","map","title","value"],"mappings":"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","sourcesContent":["import { BuildType, Job, Platform, iOS, sanitizeJob } from '@expo/build-tools';\nimport { IOSConfig } from '@expo/config';\nimport chalk from 'chalk';\nimport figures from 'figures';\nimport sortBy from 'lodash/sortBy';\nimport ora from 'ora';\n\nimport iOSCredentialsProvider, {\n  iOSCredentials,\n} from '../../../../credentials/provider/iOSCredentialsProvider';\nimport * as ProvisioningProfileUtils from '../../../../credentials/utils/provisioningProfile';\nimport {\n  CredentialsSource,\n  Workflow,\n  iOSGenericBuildProfile,\n  iOSManagedBuildProfile,\n} from '../../../../easJson';\nimport log from '../../../../log';\nimport prompts from '../../../../prompts';\nimport { Builder, BuilderContext } from '../../types';\nimport * as gitUtils from '../../utils/git';\nimport { ensureCredentialsAsync } from '../credentials';\nimport { getBundleIdentifier } from '../utils/ios';\n\ninterface CommonJobProperties {\n  platform: Platform.iOS;\n  projectUrl: string;\n  secrets?: {\n    provisioningProfileBase64: string;\n    distributionCertificate: {\n      dataBase64: string;\n      password: string;\n    };\n  };\n}\n\nclass iOSBuilder implements Builder<Platform.iOS> {\n  private credentials?: iOSCredentials;\n  private scheme?: string;\n\n  constructor(public readonly ctx: BuilderContext<Platform.iOS>) {}\n\n  public async prepareJobAsync(archiveUrl: string): Promise<Job> {\n    if (this.ctx.buildProfile.workflow === Workflow.Generic) {\n      return sanitizeJob(await this.prepareGenericJobAsync(archiveUrl, this.ctx.buildProfile));\n    } else if (this.ctx.buildProfile.workflow === Workflow.Managed) {\n      return sanitizeJob(await this.prepareManagedJobAsync(archiveUrl, this.ctx.buildProfile));\n    } else {\n      throw new Error(\"Unknown workflow. Shouldn't happen\");\n    }\n  }\n\n  public async ensureCredentialsAsync(): Promise<\n    CredentialsSource.LOCAL | CredentialsSource.REMOTE | undefined\n  > {\n    if (!this.shouldLoadCredentials()) {\n      return;\n    }\n    const bundleIdentifier = await getBundleIdentifier(\n      this.ctx.commandCtx.projectDir,\n      this.ctx.commandCtx.exp\n    );\n    const provider = new iOSCredentialsProvider(\n      this.ctx.commandCtx.projectDir,\n      {\n        projectName: this.ctx.commandCtx.projectName,\n        accountName: this.ctx.commandCtx.accountName,\n        bundleIdentifier,\n      },\n      {\n        nonInteractive: this.ctx.commandCtx.nonInteractive,\n        skipCredentialsCheck: this.ctx.commandCtx.skipCredentialsCheck,\n      }\n    );\n    await provider.initAsync();\n    const credentialsSource = await ensureCredentialsAsync(\n      provider,\n      this.ctx.buildProfile.workflow,\n      this.ctx.buildProfile.credentialsSource,\n      this.ctx.commandCtx.nonInteractive\n    );\n    this.credentials = await provider.getCredentialsAsync(credentialsSource);\n    return credentialsSource;\n  }\n\n  public async setupAsync(): Promise<void> {\n    if (this.ctx.buildProfile.workflow === Workflow.Generic) {\n      this.scheme = this.ctx.buildProfile.scheme ?? (await this.resolveScheme());\n    }\n  }\n\n  public async ensureProjectConfiguredAsync(): Promise<void> {\n    await this.configureProjectAsync();\n  }\n\n  public async configureProjectAsync(): Promise<void> {\n    if (this.ctx.buildProfile.workflow !== Workflow.Generic) {\n      return;\n    }\n\n    // TODO: add simulator flow\n    // assuming we're building for app store\n    if (!this.credentials) {\n      throw new Error('Call ensureCredentialsAsync first!');\n    }\n\n    const spinner = ora('Configuring the Xcode project');\n\n    const bundleIdentifier = await getBundleIdentifier(\n      this.ctx.commandCtx.projectDir,\n      this.ctx.commandCtx.exp\n    );\n\n    const profileName = ProvisioningProfileUtils.readProfileName(\n      this.credentials.provisioningProfile\n    );\n    const appleTeam = ProvisioningProfileUtils.readAppleTeam(this.credentials.provisioningProfile);\n\n    const { projectDir } = this.ctx.commandCtx;\n    IOSConfig.BundleIdenitifer.setBundleIdentifierForPbxproj(projectDir, bundleIdentifier, false);\n    IOSConfig.ProvisioningProfile.setProvisioningProfileForPbxproj(projectDir, {\n      profileName,\n      appleTeamId: appleTeam.teamId,\n    });\n\n    try {\n      await gitUtils.ensureGitStatusIsCleanAsync();\n      spinner.succeed();\n    } catch (err) {\n      if (err instanceof gitUtils.DirtyGitTreeError) {\n        spinner.succeed('We configured the Xcode project to build it on the Expo servers');\n        log.newLine();\n\n        try {\n          await gitUtils.reviewAndCommitChangesAsync('Configure Xcode project', {\n            nonInteractive: this.ctx.commandCtx.nonInteractive,\n          });\n\n          log(`${chalk.green(figures.tick)} Successfully committed the configuration changes.`);\n        } catch (e) {\n          throw new Error(\n            \"Aborting, run the command again once you're ready. Make sure to commit any changes you've made.\"\n          );\n        }\n      } else {\n        spinner.fail();\n        throw err;\n      }\n    }\n  }\n\n  private async prepareJobCommonAsync(archiveUrl: string): Promise<Partial<CommonJobProperties>> {\n    const secrets = this.credentials\n      ? {\n          secrets: {\n            provisioningProfileBase64: this.credentials.provisioningProfile,\n            distributionCertificate: {\n              dataBase64: this.credentials.distributionCertificate.certP12,\n              password: this.credentials.distributionCertificate.certPassword,\n            },\n          },\n        }\n      : {};\n\n    return {\n      platform: Platform.iOS,\n      projectUrl: archiveUrl,\n      ...secrets,\n    };\n  }\n\n  private async prepareGenericJobAsync(\n    archiveUrl: string,\n    buildProfile: iOSGenericBuildProfile\n  ): Promise<Partial<iOS.GenericJob>> {\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Generic,\n      scheme: this.scheme,\n      artifactPath: buildProfile.artifactPath,\n    };\n  }\n\n  private async prepareManagedJobAsync(\n    archiveUrl: string,\n    _buildProfile: iOSManagedBuildProfile\n  ): Promise<Partial<iOS.ManagedJob>> {\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Managed,\n      packageJson: { example: 'packageJson' },\n      manifest: { example: 'manifest' },\n    };\n  }\n\n  private shouldLoadCredentials(): boolean {\n    return (\n      (this.ctx.buildProfile.workflow === Workflow.Managed &&\n        this.ctx.buildProfile.buildType !== 'simulator') ||\n      this.ctx.buildProfile.workflow === Workflow.Generic\n    );\n  }\n\n  private async resolveScheme(): Promise<string> {\n    const schemes = IOSConfig.Scheme.getSchemesFromXcodeproj(this.ctx.commandCtx.projectDir);\n    if (schemes.length === 1) {\n      return schemes[0];\n    }\n\n    const sortedSchemes = sortBy(schemes);\n    log.newLine();\n    log(\n      `We've found multiple schemes in your Xcode project: ${log.chalk.bold(\n        sortedSchemes.join(', ')\n      )}`\n    );\n    log(\n      `You can specify the scheme you want to build at ${log.chalk.bold(\n        'builds.ios.PROFILE_NAME.scheme'\n      )} in eas.json.`\n    );\n    if (this.ctx.commandCtx.nonInteractive) {\n      const withoutTvOS = sortedSchemes.filter(i => !i.includes('tvOS'));\n      const scheme = withoutTvOS.length > 0 ? withoutTvOS[0] : sortedSchemes[0];\n      log(\n        `You've run Expo CLI in non-interactive mode, choosing the ${log.chalk.bold(\n          scheme\n        )} scheme.`\n      );\n      log.newLine();\n      return scheme;\n    } else {\n      const { selectedScheme } = await prompts({\n        type: 'select',\n        name: 'selectedScheme',\n        message: 'Which scheme would you like to build now?',\n        choices: sortedSchemes.map(scheme => ({ title: scheme, value: scheme })),\n      });\n      log.newLine();\n      return selectedScheme as string;\n    }\n  }\n}\n\nexport default iOSBuilder;\n"],"file":"iOSBuilder.js"}