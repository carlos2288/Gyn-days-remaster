{"version":3,"sources":["../../../../../src/commands/eas-build/build/builders/AndroidBuilder.ts"],"names":["AndroidBuilder","constructor","ctx","setupAsync","ensureCredentialsAsync","credentialsPrepared","shouldLoadCredentials","provider","AndroidCredentialsProvider","commandCtx","projectDir","projectName","accountName","nonInteractive","initAsync","credentialsSource","buildProfile","workflow","credentials","getCredentialsAsync","isProjectConfiguredAsync","androidAppDir","path","join","buildGradlePath","easGradlePath","hasEasGradleFile","fs","pathExists","buildGradleContent","readFile","applyEasGradle","hasEasGradleApply","split","some","line","replace","ensureProjectConfiguredAsync","CommandError","configureProjectAsync","spinner","succeed","writeFile","gradleContent","intentToAdd","trim","gitUtils","ensureGitStatusIsCleanAsync","err","DirtyGitTreeError","log","newLine","reviewAndCommitChangesAsync","chalk","green","figures","tick","e","Error","fail","prepareJobAsync","archiveUrl","Workflow","Generic","prepareGenericJobAsync","Managed","prepareManagedJobAsync","prepareJobCommonAsync","secrets","keystore","dataBase64","keystorePassword","keyAlias","keyPassword","platform","Platform","Android","projectUrl","type","BuildType","gradleCommand","artifactPath","_buildProfile","packageJson","example","manifest","withoutCredentials"],"mappings":"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","sourcesContent":["import { Android, BuildType, Job, Platform, sanitizeJob } from '@expo/build-tools';\nimport chalk from 'chalk';\nimport figures from 'figures';\nimport fs from 'fs-extra';\nimport ora from 'ora';\nimport path from 'path';\n\nimport CommandError from '../../../../CommandError';\nimport AndroidCredentialsProvider, {\n  AndroidCredentials,\n} from '../../../../credentials/provider/AndroidCredentialsProvider';\nimport {\n  AndroidGenericBuildProfile,\n  AndroidManagedBuildProfile,\n  CredentialsSource,\n  Workflow,\n} from '../../../../easJson';\nimport { gitAddAsync } from '../../../../git';\nimport log from '../../../../log';\nimport { Builder, BuilderContext } from '../../types';\nimport * as gitUtils from '../../utils/git';\nimport { ensureCredentialsAsync } from '../credentials';\nimport gradleContent from '../templates/gradleContent';\n\ninterface CommonJobProperties {\n  platform: Platform.Android;\n  projectUrl: string;\n  secrets?: {\n    keystore: Android.Keystore;\n  };\n}\n\nclass AndroidBuilder implements Builder<Platform.Android> {\n  private credentials?: AndroidCredentials;\n  private credentialsPrepared: boolean = false;\n\n  constructor(public readonly ctx: BuilderContext<Platform.Android>) {}\n\n  public async setupAsync(): Promise<void> {}\n\n  public async ensureCredentialsAsync(): Promise<\n    CredentialsSource.LOCAL | CredentialsSource.REMOTE | undefined\n  > {\n    this.credentialsPrepared = true;\n    if (!this.shouldLoadCredentials()) {\n      return;\n    }\n    const provider = new AndroidCredentialsProvider(\n      this.ctx.commandCtx.projectDir,\n      {\n        projectName: this.ctx.commandCtx.projectName,\n        accountName: this.ctx.commandCtx.accountName,\n      },\n      { nonInteractive: this.ctx.commandCtx.nonInteractive }\n    );\n    await provider.initAsync();\n    const credentialsSource = await ensureCredentialsAsync(\n      provider,\n      this.ctx.buildProfile.workflow,\n      this.ctx.buildProfile.credentialsSource,\n      this.ctx.commandCtx.nonInteractive\n    );\n    this.credentials = await provider.getCredentialsAsync(credentialsSource);\n    return credentialsSource;\n  }\n\n  private async isProjectConfiguredAsync(): Promise<boolean> {\n    const androidAppDir = path.join(this.ctx.commandCtx.projectDir, 'android', 'app');\n    const buildGradlePath = path.join(androidAppDir, 'build.gradle');\n    const easGradlePath = path.join(androidAppDir, 'eas-build.gradle');\n\n    const hasEasGradleFile = await fs.pathExists(easGradlePath);\n\n    const buildGradleContent = await fs.readFile(path.join(buildGradlePath), 'utf-8');\n    const applyEasGradle = 'apply from: \"./eas-build.gradle\"';\n\n    const hasEasGradleApply = buildGradleContent\n      .split('\\n')\n      // Check for both single and double quotes\n      .some(line => line === applyEasGradle || line === applyEasGradle.replace(/\"/g, \"'\"));\n\n    return hasEasGradleApply && hasEasGradleFile;\n  }\n\n  public async ensureProjectConfiguredAsync(): Promise<void> {\n    if (!(await this.isProjectConfiguredAsync())) {\n      throw new CommandError(\n        'Project is not configured. Please run \"expo eas:build:init\" first to configure the project'\n      );\n    }\n  }\n\n  public async configureProjectAsync(): Promise<void> {\n    const spinner = ora('Making sure your Android project is set up properly');\n\n    if (await this.isProjectConfiguredAsync()) {\n      spinner.succeed('Android project is already configured');\n      return;\n    }\n\n    const { projectDir } = this.ctx.commandCtx;\n\n    const androidAppDir = path.join(projectDir, 'android', 'app');\n    const buildGradlePath = path.join(androidAppDir, 'build.gradle');\n    const easGradlePath = path.join(androidAppDir, 'eas-build.gradle');\n\n    await fs.writeFile(easGradlePath, gradleContent);\n    await gitAddAsync(easGradlePath, { intentToAdd: true });\n\n    const buildGradleContent = await fs.readFile(path.join(buildGradlePath), 'utf-8');\n    const applyEasGradle = 'apply from: \"./eas-build.gradle\"';\n\n    await fs.writeFile(buildGradlePath, `${buildGradleContent.trim()}\\n${applyEasGradle}\\n`);\n\n    try {\n      await gitUtils.ensureGitStatusIsCleanAsync();\n      spinner.succeed();\n    } catch (err) {\n      if (err instanceof gitUtils.DirtyGitTreeError) {\n        spinner.succeed('We configured your Android project to build it on the Expo servers');\n        log.newLine();\n\n        try {\n          await gitUtils.reviewAndCommitChangesAsync('Configure Android project', {\n            nonInteractive: this.ctx.commandCtx.nonInteractive,\n          });\n\n          log(`${chalk.green(figures.tick)} Successfully committed the configuration changes.`);\n        } catch (e) {\n          throw new Error(\n            \"Aborting, run the command again once you're ready. Make sure to commit any changes you've made.\"\n          );\n        }\n      } else {\n        spinner.fail();\n        throw err;\n      }\n    }\n  }\n\n  public async prepareJobAsync(archiveUrl: string): Promise<Job> {\n    if (!this.credentialsPrepared) {\n      throw new Error('ensureCredentialsAsync should be called before prepareJobAsync');\n    }\n    if (this.ctx.buildProfile.workflow === Workflow.Generic) {\n      return sanitizeJob(await this.prepareGenericJobAsync(archiveUrl, this.ctx.buildProfile));\n    } else if (this.ctx.buildProfile.workflow === Workflow.Managed) {\n      return sanitizeJob(await this.prepareManagedJobAsync(archiveUrl, this.ctx.buildProfile));\n    } else {\n      throw new Error(\"Unknown workflow. Shouldn't happen\");\n    }\n  }\n\n  private async prepareJobCommonAsync(archiveUrl: string): Promise<Partial<CommonJobProperties>> {\n    const secrets = this.credentials\n      ? {\n          secrets: {\n            keystore: {\n              dataBase64: this.credentials.keystore.keystore,\n              keystorePassword: this.credentials.keystore.keystorePassword,\n              keyAlias: this.credentials.keystore.keyAlias,\n              keyPassword: this.credentials.keystore.keyPassword,\n            },\n          },\n        }\n      : {};\n\n    return {\n      platform: Platform.Android,\n      projectUrl: archiveUrl,\n      ...secrets,\n    };\n  }\n\n  private async prepareGenericJobAsync(\n    archiveUrl: string,\n    buildProfile: AndroidGenericBuildProfile\n  ): Promise<Partial<Android.GenericJob>> {\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Generic,\n      gradleCommand: buildProfile.gradleCommand,\n      artifactPath: buildProfile.artifactPath,\n    };\n  }\n\n  private async prepareManagedJobAsync(\n    archiveUrl: string,\n    _buildProfile: AndroidManagedBuildProfile\n  ): Promise<Partial<Android.ManagedJob>> {\n    return {\n      ...(await this.prepareJobCommonAsync(archiveUrl)),\n      type: BuildType.Managed,\n      packageJson: { example: 'packageJson' },\n      manifest: { example: 'manifest' },\n    };\n  }\n\n  private shouldLoadCredentials(): boolean {\n    return (\n      this.ctx.buildProfile.workflow === Workflow.Managed ||\n      (this.ctx.buildProfile.workflow === Workflow.Generic &&\n        !this.ctx.buildProfile.withoutCredentials)\n    );\n  }\n}\n\nexport default AndroidBuilder;\n"],"file":"AndroidBuilder.js"}