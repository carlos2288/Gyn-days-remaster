{"version":3,"sources":["../../../src/commands/eject/ConfigValidation.ts"],"names":["noBundleIdMessage","noPackageMessage","validateBundleId","value","test","validatePackage","getOrPromptForBundleIdentifier","projectRoot","exp","skipSDKVersionRequirement","currentBundleId","ios","bundleIdentifier","log","chalk","red","process","exit","recommendedBundleId","android","package","username","owner","UserManager","getCurrentUsernameAsync","possibleId","slug","addNewLineIfNone","cyan","newLine","name","default","message","validate","nonInteractiveHelp","attemptModification","getOrPromptForPackage","currentPackage","recommendedPackage","split","join","packageName","modificationSuccessMessage","edits","exactEdits","modification","type","warnAboutConfigAndExit","logNoConfig","yellow","notifyAboutManualConfigEdits","JSON","stringify"],"mappings":"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","sourcesContent":["import { ExpoConfig, getConfig, modifyConfigAsync } from '@expo/config';\nimport { UserManager } from '@expo/xdl';\nimport terminalLink from 'terminal-link';\n\nimport log from '../../log';\nimport prompt from '../../prompt';\n\nconst noBundleIdMessage = `Your project must have a \\`bundleIdentifier\\` set in the Expo config (app.json or app.config.js).\\nSee https://expo.fyi/bundle-identifier`;\nconst noPackageMessage = `Your project must have a \\`package\\` set in the Expo config (app.json or app.config.js).\\nSee https://expo.fyi/android-package`;\n\nfunction validateBundleId(value: string): boolean {\n  return /^[a-zA-Z][a-zA-Z0-9\\-.]+$/.test(value);\n}\n\nfunction validatePackage(value: string): boolean {\n  return /^[a-zA-Z][a-zA-Z0-9_]*(\\.[a-zA-Z][a-zA-Z0-9_]*)+$/.test(value);\n}\n\nexport async function getOrPromptForBundleIdentifier(projectRoot: string): Promise<string> {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  const currentBundleId = exp.ios?.bundleIdentifier;\n  if (currentBundleId) {\n    if (validateBundleId(currentBundleId)) {\n      return currentBundleId;\n    }\n\n    log(\n      log.chalk.red(\n        `The ios.bundleIdentifier defined in your Expo config is not formatted properly. Only alphanumeric characters, '.', '-', and '_' are allowed, and each '.' must be followed by a letter.`\n      )\n    );\n\n    process.exit(1);\n  }\n\n  // Recommend a bundle ID based on the username and project slug.\n  let recommendedBundleId: string | undefined;\n  // Attempt to use the android package name first since it's convenient to have them aligned.\n  if (exp.android?.package && validateBundleId(exp.android?.package)) {\n    recommendedBundleId = exp.android?.package;\n  } else {\n    const username = exp.owner ?? (await UserManager.getCurrentUsernameAsync());\n    const possibleId = `com.${username}.${exp.slug}`;\n    if (username && validateBundleId(possibleId)) {\n      recommendedBundleId = possibleId;\n    }\n  }\n\n  log.addNewLineIfNone();\n  log(\n    log.chalk.cyan(\n      `Now we need to know your ${terminalLink(\n        'iOS bundle identifier',\n        'https://expo.fyi/bundle-identifier'\n      )}.\\nYou can change this in the future if you need to.`\n    )\n  );\n  log.newLine();\n\n  // Prompt the user for the bundle ID.\n  // Even if the project is using a dynamic config we can still\n  // prompt a better error message, recommend a default value, and help the user\n  // validate their custom bundle ID upfront.\n  const { bundleIdentifier } = await prompt(\n    [\n      {\n        name: 'bundleIdentifier',\n        default: recommendedBundleId,\n        // The Apple helps people know this isn't an EAS feature.\n        message: `What would you like your iOS bundle identifier to be?`,\n        validate: validateBundleId,\n      },\n    ],\n    {\n      nonInteractiveHelp: noBundleIdMessage,\n    }\n  );\n\n  await attemptModification(\n    projectRoot,\n    `Your iOS bundle identifier is now: ${bundleIdentifier}`,\n    {\n      ios: { ...(exp.ios || {}), bundleIdentifier },\n    },\n    { ios: { bundleIdentifier } }\n  );\n\n  return bundleIdentifier;\n}\n\nexport async function getOrPromptForPackage(projectRoot: string): Promise<string> {\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n\n  const currentPackage = exp.android?.package;\n  if (currentPackage) {\n    if (validatePackage(currentPackage)) {\n      return currentPackage;\n    }\n    log(\n      log.chalk.red(\n        `Invalid format of Android package name. Only alphanumeric characters, '.' and '_' are allowed, and each '.' must be followed by a letter.`\n      )\n    );\n\n    process.exit(1);\n  }\n\n  // Recommend a package name based on the username and project slug.\n  let recommendedPackage: string | undefined;\n  // Attempt to use the ios bundle id first since it's convenient to have them aligned.\n  if (exp.ios?.bundleIdentifier && validatePackage(exp.ios.bundleIdentifier)) {\n    recommendedPackage = exp.ios.bundleIdentifier;\n  } else {\n    const username = exp.owner ?? (await UserManager.getCurrentUsernameAsync());\n    // It's common to use dashes in your node project name, strip them from the suggested package name.\n    const possibleId = `com.${username}.${exp.slug}`.split('-').join('');\n    if (username && validatePackage(possibleId)) {\n      recommendedPackage = possibleId;\n    }\n  }\n\n  log.addNewLineIfNone();\n  log(\n    `Now we need to know your ${terminalLink(\n      'Android package',\n      'https://expo.fyi/android-package'\n    )}. You can change this in the future if you need to.`\n  );\n  log.newLine();\n\n  // Prompt the user for the android package.\n  // Even if the project is using a dynamic config we can still\n  // prompt a better error message, recommend a default value, and help the user\n  // validate their custom android package upfront.\n  const { packageName } = await prompt(\n    [\n      {\n        name: 'packageName',\n        default: recommendedPackage,\n        message: `What would you like your Android package to be named?`,\n        validate: validatePackage,\n      },\n    ],\n    {\n      nonInteractiveHelp: noPackageMessage,\n    }\n  );\n\n  await attemptModification(\n    projectRoot,\n    `Your Android package is now: ${packageName}`,\n    {\n      android: { ...(exp.android || {}), package: packageName },\n    },\n    {\n      android: { package: packageName },\n    }\n  );\n\n  return packageName;\n}\n\nasync function attemptModification(\n  projectRoot: string,\n  modificationSuccessMessage: string,\n  edits: Partial<ExpoConfig>,\n  exactEdits: Partial<ExpoConfig>\n): Promise<void> {\n  const modification = await modifyConfigAsync(projectRoot, edits, {\n    skipSDKVersionRequirement: true,\n  });\n  if (modification.type === 'success') {\n    log.addNewLineIfNone();\n    log(modificationSuccessMessage);\n    log.newLine();\n  } else {\n    warnAboutConfigAndExit(modification.type, modification.message!, exactEdits);\n  }\n}\n\nfunction logNoConfig() {\n  log(\n    log.chalk.yellow(\n      'No Expo config was found. Please create an Expo config (`app.config.js` or `app.json`) in your project root.'\n    )\n  );\n}\n\nfunction warnAboutConfigAndExit(type: string, message: string, edits: Partial<ExpoConfig>) {\n  log.addNewLineIfNone();\n  if (type === 'warn') {\n    // The project is using a dynamic config, give the user a helpful log and bail out.\n    log(log.chalk.yellow(message));\n  } else {\n    logNoConfig();\n  }\n\n  notifyAboutManualConfigEdits(edits);\n  process.exit(1);\n}\n\nfunction notifyAboutManualConfigEdits(edits: Partial<ExpoConfig>) {\n  log(log.chalk.cyan(`Please add the following to your Expo config, and try again... `));\n  log.newLine();\n  log(JSON.stringify(edits, null, 2));\n  log.newLine();\n}\n"],"file":"ConfigValidation.js"}