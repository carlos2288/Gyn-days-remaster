{"version":3,"sources":["../../src/commands/push-creds-web.ts"],"names":["vapidSubjectDescription","program","command","description","helpGroup","option","asyncActionProjectDir","projectDir","options","vapidPubkey","vapidPvtkey","vapidSubject","Error","_uploadWebPushCredientials","results","chalk","green","vapidPublicKey","vapidPrivateKey","args","remotePackageName","Exp","getPublishInfoAsync","user","UserManager","getCurrentUserAsync","apiClient","ApiV2","clientForUser","result","getAsync","status","JSON","stringify","error","deleteAsync","isGeneration","putAsync","oldVapidData","yellow","yellowBright","configPath","ConfigUtils","findConfigFile","appJson","parse","fs","readFile","then","value","toString","changedProperties","expo","owner","username","push","notification","cyan","length","writeFile","join"],"mappings":"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","sourcesContent":["import * as ConfigUtils from '@expo/config';\nimport { ApiV2, Exp, UserManager } from '@expo/xdl';\nimport chalk from 'chalk';\nimport { Command } from 'commander';\nimport fs from 'fs-extra';\n\nimport log from '../log';\n\ntype VapidData = {\n  vapidSubject: string;\n  vapidPubkey?: string;\n  vapidPvtkey?: string;\n};\n\nconst vapidSubjectDescription =\n  'URL or `mailto:` URL which provides a point of contact in case the push service needs to contact the message sender.';\n\nexport default function (program: Command) {\n  program\n    .command('push:web:upload [path]')\n    .description('Upload VAPID key pair and VAPID subject for web push notifications.')\n    .helpGroup('notifications')\n    .option('--vapid-pubkey [vapid-public-key]', 'URL-safe base64-encoded VAPID public key.')\n    .option('--vapid-pvtkey [vapid-private-key]', 'URL-safe base64-encoded VAPID private key.')\n    .option('--vapid-subject [vapid-subject]', vapidSubjectDescription)\n    .asyncActionProjectDir(async (projectDir: string, options: VapidData) => {\n      if (!options.vapidPubkey || !options.vapidPvtkey || !options.vapidSubject) {\n        throw new Error(\n          'Must specify all three fields (--vapid-pubkey, --vapid-pvtkey, and --vapid-subject) to upload.'\n        );\n      }\n\n      await _uploadWebPushCredientials(projectDir, options);\n    });\n\n  program\n    .command('push:web:generate [path]')\n    .description('Generate VAPID key pair for web push notifications.')\n    .helpGroup('notifications')\n    .option('--vapid-subject [vapid-subject]', vapidSubjectDescription)\n    .asyncActionProjectDir(async (projectDir: string, options: VapidData) => {\n      if (!options.vapidSubject) {\n        throw new Error('Must specify --vapid-subject.');\n      }\n\n      const results = await _uploadWebPushCredientials(projectDir, options);\n      log(chalk.green(`Your VAPID public key is: ${results.vapidPublicKey}`));\n      log(chalk.green(`Your VAPID private key is: ${results.vapidPrivateKey}`));\n    });\n\n  program\n    .command('push:web:show [path]')\n    .description(\n      'Log the VAPID public key, the VAPID private key, and the VAPID subject currently in use for web notifications for this project.'\n    )\n    .helpGroup('notifications')\n    .asyncActionProjectDir(async (projectDir: string) => {\n      const {\n        args: { remotePackageName },\n      } = await Exp.getPublishInfoAsync(projectDir);\n      const user = await UserManager.getCurrentUserAsync();\n      const apiClient = ApiV2.clientForUser(user);\n\n      const result = await apiClient.getAsync(`credentials/push/web/${remotePackageName}`);\n\n      if (\n        result.status === 'ok' &&\n        result.vapidPublicKey &&\n        result.vapidPrivateKey &&\n        result.vapidSubject\n      ) {\n        log(JSON.stringify(result));\n      } else if (result.status === 'error') {\n        throw new Error(`Server returned an error: ${result.error}`);\n      } else {\n        throw new Error('Server returned an invalid result!');\n      }\n    });\n\n  program\n    .command('push:web:clear [path]')\n    .description(\n      'Delete previously uploaded VAPID public key, VAPID private key, and VAPID subject.'\n    )\n    .helpGroup('notifications')\n    .asyncActionProjectDir(async (projectDir: string) => {\n      log('Reading project configuration...');\n      const {\n        args: { remotePackageName },\n      } = await Exp.getPublishInfoAsync(projectDir);\n\n      log('Logging in...');\n      const user = await UserManager.getCurrentUserAsync();\n      const apiClient = ApiV2.clientForUser(user);\n\n      log(\"Deleting API key from Expo's servers...\");\n\n      await apiClient.deleteAsync(`credentials/push/web/${remotePackageName}`);\n    });\n}\n\nasync function _uploadWebPushCredientials(projectDir: string, options: VapidData) {\n  const isGeneration = !(options.vapidPubkey && options.vapidPvtkey);\n\n  log('Reading project configuration...');\n\n  const {\n    args: { remotePackageName },\n  } = await Exp.getPublishInfoAsync(projectDir);\n\n  log('Logging in...');\n\n  const user = await UserManager.getCurrentUserAsync();\n  const apiClient = ApiV2.clientForUser(user);\n\n  if (isGeneration) {\n    log(\"Generating and setting VAPID keys on Expo's servers...\");\n  } else {\n    log(\"Uploading VAPID keys to Expo's servers...\");\n  }\n\n  const results = await apiClient.putAsync(`credentials/push/web/${remotePackageName}`, {\n    vapidPublicKey: options.vapidPubkey,\n    vapidPrivateKey: options.vapidPvtkey,\n    vapidSubject: options.vapidSubject,\n  });\n\n  if (results.oldVapidData && results.oldVapidData.vapidPublicKey !== results.vapidPublicKey) {\n    log(\n      chalk.yellow(\n        `Warning: You have previously stored another VAPID key pair on Expo's servers. Your current action has overridden the old key pair. This means that all your web clients will not receive any new notifications from you until you have deployed the app containing the new VAPID public key, and that the user has visited the site again since then.`\n      )\n    );\n    log(chalk.yellow(`For your records:`));\n    log(chalk.yellow(`- Your old VAPID public key: ${results.oldVapidData.vapidPublicKey}`));\n    log(chalk.yellow(`- Your old VAPID private key: ${results.oldVapidData.vapidPrivateKey}`));\n    log(chalk.yellow(`- Your old VAPID subject: ${results.oldVapidData.vapidSubject}`));\n    log(\n      chalk.yellow(\n        `If you wish to undo the current action, you can use the following command to upload your old credentials back to Expo's servers:`\n      )\n    );\n    log(\n      chalk.yellowBright(\n        `expo push:web:upload --vapid-pubkey ${results.oldVapidData.vapidPublicKey} --vapid-pvtkey ${results.oldVapidData.vapidPrivateKey} --vapid-subject ${results.oldVapidData.vapidSubject}`\n      )\n    );\n  }\n  log(chalk.green(`VAPID data uploaded!`));\n\n  /**\n   * Customize app.json\n   */\n  log(`Reading app.json...`);\n  const { configPath } = ConfigUtils.findConfigFile(projectDir);\n  const appJson = JSON.parse(await fs.readFile(configPath).then(value => value.toString()));\n  const changedProperties = [];\n\n  if (user) {\n    if (appJson.expo.owner && appJson.expo.owner !== user.username) {\n      log(\n        chalk.yellow(\n          `Warning: expo.owner is already configured to be \"${appJson.expo.owner}\" in app.json, but your current username is \"${user.username}\". You will not receive any push notification if you do not change expo.owner to \"${user.username}\" in app.json. Alternatively, you could choose to login to \"${appJson.expo.owner}\" and then execute this command again.`\n        )\n      );\n    } else {\n      appJson.expo.owner = user.username;\n      changedProperties.push('expo.owner');\n    }\n  }\n\n  if (\n    appJson.expo?.notification?.vapidPublicKey &&\n    appJson.expo.notification.vapidPublicKey !== results.vapidPublicKey\n  ) {\n    log(\n      chalk.cyan(\n        `Notice: expo.notification.vapidPublicKey is already configured in app.json (${\n          appJson.expo.notification.vapidPublicKey\n        }), but it is different from the VAPID public key you just ${\n          isGeneration ? `generated` : `uploaded`\n        }. We will replace it with the new VAPID public key.`\n      )\n    );\n  }\n  if (!appJson.expo.notification) {\n    appJson.expo.notification = {};\n  }\n  appJson.expo.notification.vapidPublicKey = results.vapidPublicKey;\n  changedProperties.push('expo.notification.vapidPublicKey');\n\n  if (changedProperties.length) {\n    log(`Writing to app.json...`);\n    await fs.writeFile(configPath, JSON.stringify(appJson, null, 2));\n    log(chalk.green(`Wrote ${changedProperties.join(', ')} to app.json.`));\n  }\n\n  log(chalk.green('All done!'));\n\n  return results;\n}\n"],"file":"push-creds-web.js"}